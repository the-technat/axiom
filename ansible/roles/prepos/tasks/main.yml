---
# Credits to https://github.com/k3s-io/k3s-ansible/blob/master/roles/prereq/tasks/main.yml

# https://docs.k3s.io/advanced#red-hat-enterprise-linux--centos--fedora
- name: Set SELinux to disabled state
  ansible.posix.selinux:
    state: disabled
  when: ansible_distribution in ['CentOS', 'Red Hat Enterprise Linux']
- name: Disable nm-cloud-setup
  ansible.builtin.systemd:
    name: nm-cloud-setup
    state: stopped
    enabled: false
  when: ansible_distribution in ['CentOS', 'Red Hat Enterprise Linux']
- name: Disable firewalld
  ansible.builtin.systemd:
    name: firewalld
    state: stopped
    enabled: false
  when: ansible_distribution in ['CentOS', 'Red Hat Enterprise Linux']

# https://docs.k3s.io/advanced#ubuntu--debian
- name: Disable ufw
  ansible.builtin.systemd:
    name: ufw
    state: stopped
    enabled: false
  when: ansible_distribution in ['Debian', 'Ubuntu']

# Common
# Two options: console with password or tailscale ssh but no traditional ssh
- name: SSH is masked
  ansible.builtin.systemd:
    name: ssh
    state: stopped
    masked: true
- name: Enable IPv4 forwarding
  ansible.posix.sysctl:
    name: net.ipv4.ip_forward
    value: "1"
    state: present
    reload: true
- name: Enable IPv6 forwarding
  ansible.posix.sysctl:
    name: net.ipv6.conf.all.forwarding
    value: "1"
    state: present
    reload: true
  when: ansible_all_ipv6_addresses
- name: Add /usr/local/bin to sudo secure_path
  ansible.builtin.lineinfile:
    line: 'Defaults    secure_path = /sbin:/bin:/usr/sbin:/usr/bin:/usr/local/bin'
    regexp: "Defaults(\\s)*secure_path(\\s)*="
    state: present
    insertafter: EOF
    path: /etc/sudoers
    validate: 'visudo -cf %s'